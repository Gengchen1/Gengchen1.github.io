---
title: 卡尔曼滤波
date: 2025-05-07
summary: 卡尔曼滤波其实就是从预测值和测量值中得出最优估计的一种算法。
category: 最优控制
tags:
  - 最优控制
comments: true
---

> 卡尔曼滤波（Kalman Filter）一种通过**预测**和**校正**对系统状态进行最优估计的算法，预测包含计算先验估计和状态误差协方差矩阵，校正包含计算卡尔曼增益、后验估计和更新状态误差协方差矩阵用于下一次求解。

_卡尔曼滤波器其实可以看作是一种最优递归数据处理算法（optimal recurise Data processing Algorithm）_。
只不过由于观测数据中包括系统的噪声和干扰影响，所以最有估计也可看作是滤波过程。

卡尔曼滤波器在工程中常常会用到，因为我们的世界存在很多不确定性，在工程中的不确定性有：

- 不存在完美的数学模型；
- 系统的扰动不可控，也很难建模；
- 测量传感器存在误差；

## 递归算法

估计真实值->对测量值取平均：
假设$z_k$是第k次的测量值，$\hat{X}_k$是从1~k次的平均值，也叫估计值。

$$
\hat{X}_{k}=\frac{1}{k}(z_{i}+z_{i}+\cdots+z_{k})
$$

可以转换成以下形式：

$$
\hat{X}_{k}\quad=\quad\hat{X}_{k-1}\quad+\frac{1}{k}(z_{k}-\hat{X}_{k-1})
$$

可以看到**第$k$次估计值只和当前测量值$z_k$和上一次的估计值$\hat{X}_{k-1}$有关。** 这就是一种递归。也是卡尔曼滤波的优势之一，可以在线进行数据的处理，不需要得到所有数据后再进行处理。

_随着$k$的增加，测量值就不再那么重要了。_ 这也符合直觉，当测量次数增多了之后，就对估计值很有信心了，后续的测量值相对就没那么重要了。

将$\frac{1}{k}$替换成系数$K_k$：

$$
\hat{X}_{k}\quad=\quad\hat{X}_{k-1}\quad+K_k(z_{k}-\hat{X}_{k-1})
$$

就变成了$\text{当前的估计值} = \text{上一次的估计值} + \text{系数}\times (\text{当前测量值} - \text{上一次的估计值})$
这里的系数就是卡尔曼增益/因数。
所以说卡尔曼滤波不需要考虑很久之前的数据 ，只需要考虑上一时刻的估计值即可。马尔可夫性质？

下面提出两个概念：

- 估计误差$e_{EST}$，`estimate`估计；
- 测量误差$e_{MEA}$，`measurement`测量；
  则卡尔曼增益的表达形式为：

$$
K_k = \frac{e_{{EST}_{k-1}}}{e_{{EST}_{k-1}} + e_{{MEA}_k}}
$$

$k$时刻的卡尔曼滤波增益 = $k-1$时刻的估计误差 / $k-1$时刻的估计误差 + $k$时刻的测量误差。

从直觉上理解该公式：_当估计误差相对较大时，卡尔曼增益较大，说明当前测量值就比较重要，当测量误差相对较大时，卡尔曼增益较小，说明当前测量值不那么重要。_

## 卡尔曼滤波器解决实际问题

实际过程分为以下三步：

1. 计算`kalman Gain`即卡尔曼增益 ： $K_k = \frac{e_{{EST}_{k-1}}}{e_{{EST}_{k-1}} + e_{{MEA}_k}}$；
2. 计算当前时刻的估计值：$\hat{X}_{k}\quad=\quad\hat{X}_{k-1}\quad+K_k(z_{k}-\hat{X}_{k-1})$；
3. 更新当前时刻估计误差$e_{{EST}_k}$：$e_{{EST}_k} = (1 - K_k)e_{{EST}_{k-1}}$; 后续会详细推导

**初始估计值和估计误差可以先给随机值**

## 数据融合`Data Fusion`

> 卡尔曼增益的目的是使得估计值的方差最小。

![数据融合示意图](/images/kalman/data_fusion.png)

将两个独立正态分布的测量值通过卡尔曼滤波得到估计值的正态分布，这就是数据融合。
比如说：
$z_1$是一个称(方差为2)的测量值，$z_2$是另一个称(方差为4)的测量值，则$\hat{Z}$估计值(方差最小)可以通过卡尔曼滤波得到。

![卡尔曼滤波融合示例](/images/kalman/kalman_example.png)

## 协方差矩阵

> 方差、协方差在一个矩阵中表现出来 ->**变量间的联动关系**。

比如有三个随机量$x,y,z$，它们的方差是${\sigma_x}^2$、${\sigma_y}^2$和${\sigma_z}^2$，而$x,y$它们的协方差就是$\sigma_x\sigma_y$。
它们的协方差矩阵可以表示为：

$$P=\begin{bmatrix}\sigma_{x}^{2}&\sigma_{x}\sigma_{y}&\sigma_{x}\sigma_{z}\\\sigma_{y}\sigma_{x}&\sigma_{y}^{2}&\sigma_{y}\sigma_{z}\\\sigma_{z}\sigma_{x}&\sigma_{z}\sigma_{y}&\sigma_{z}^{2}\end{bmatrix}$$

**过渡矩阵**：

$$\left.a=\left[\begin{array}{ccc}{x_{1},y_{1},z_{1}}\\{x_{2},y_{2},z_{2}}\\{x_{3},y_{3},z_{3}}\end{array}\right.\right]-\frac{1}{3}\begin{bmatrix}{1,1,1}\\{1,1,1}\\{1,1,1}\end{bmatrix}\begin{bmatrix}{x_{1},y_{1},z_{1}}\\{x_{2},y_{2},z_{2}}\\{x_{3},y_{3},z_{3}}\end{bmatrix}$$

过渡矩阵中的元素是当前值-平均值。
则协方差矩阵$P$等于：

$$
P = \frac{1}{3}a^Ta
$$

_协方差主要表达了不同变量之间的相关程度。_

## 状态空间方程表达

_注意的是，离散形式的状态空间表达形式和连续的状态空间表达形式中的系数矩阵$A$和$B$是不同的。_

离线形式的状态空间表达形式：
计算值：

$$
X_k = AX_{k-1} + BU_{k-1} + w_{k-1}
$$

其中$w_{k-1}$是过程噪音。

测量值：

$$
Z_k = HX_k + v_k
$$

其中$v_k$是测量噪音。
可以看到由于实际世界中存在的噪音，**模型和测量值都具有一定的不确定性，如何估计一个相对精确的$\hat{X_k}$?** 因此，卡尔曼滤波出现了。

我们的目的就是从这两个不太精确，方差稍大的结果中估计一个方差较小的结果（数据融合）。

## 卡尔曼增益详细推导

协方差和期望之间的关系：

$$
Cov(x_1, x_2) = E(x_1x_2)-E(x_1)E(x_2)
$$

先验结果：

$$
\hat{X_k^-} = A\hat{X}_{k-1}+BU_{k-1}
$$

测量/观测值：

$$
X_k = H^{-1}Z_k
$$

则后验结果由卡尔曼滤波得到：

$$\hat{X}_{k}=\hat{X}_{k}^{-}+G(H^{-}Z_{k}-\hat{X}_{k}^{-})$$

$G = K_kH$，则上式可以化成：

$$\hat{X}_{k}=\hat{X}_{k}^{-}+K_{k}(Z_{k}-H\hat{X}_{k}^{-})$$

其中$K_k\in[0,H^-]$。

**目标**：寻找$K_k$使得$\hat{X_k}$趋近于实际值$X_k$，而选择$K_k$又取决于噪音，噪音大说明误差大，如果计算结果噪音大，就更相信观测结果，如果观测噪音大，就更相信计算结果。

设误差为$e_k = X_k - \hat{X_k}$，且符合正态分布$p(e_{k})\sim(0,P)$，这里的P是协方差矩阵，因为期望为0，所以协方差矩阵可以表示为$P = E[ee^T]$。

- 方差和期望的关系：$D(X_1X_2) = E(X_1X_2) - E(X_1)E(X_2)$
- 若$X_1$和$X_2$相互独立，则：$D(X_1X_2) = D(X_1)D(X_2)$

目标也就是误差最小，因为方差越小，越接近期望0，说明误差越小，也就是协方差矩阵的`trace`也就是迹最小，也就是协方差矩阵的对角线相加。_协方差矩阵非对角线元素数值的含义是不同变量之间的关系。_

**因此目标就是找到一个$K_k$使得协方差矩阵的迹最小。**

- 矩阵的转置：$(AB)^T = B^TA^T$.
- _一个矩阵和它的转置的迹是相等的。_
- 矩阵 $A$ 的转置 $A^T$ 是将$A$ 的行和列互换后得到的矩阵。
- !!! $\frac{\mathrm{d}tr(AB)}{\mathrm{d}A}=B^T$ AxB矩阵的迹对A求导等于B矩阵的转置。
- $\frac{\mathrm{d}tr(ABA^T)}{\mathrm{d}A}=2AB$
- 协方差矩阵的转置等于协方差矩阵本身，因为协方差矩阵是一个对称矩阵。
- $\begin{aligned}\frac{\partial\mathbf{w}^T\mathbf{a}}{\partial\mathbf{w}}=\frac{\partial\mathbf{a}^T\mathbf{w}}{\partial\mathbf{w}}=\mathbf{a}\\\frac{\partial\mathbf{w}^TH\mathbf{w}}{\partial\mathbf{w}}=2H\mathbf{w}\end{aligned}$

通过对误差协方差矩阵的迹求导，令导数为0，得出$K_k$:

$$K_{k}=\frac{P_{k}^-H^{T}}{HP_{k}^-H^{T}+R}$$

其中$R$是观测误差$vk$的方差，而$P_k^-$是先验误差$X_k - \hat{X_k^-}$的协方差矩阵。

_可以看到，当R很大时，即测量噪声很大，$K_k$趋近于0，$\hat{X}_k$就等于先验估计$\hat{X_k^-}$，而当R很小时，$K_k$等于$H^{-1}$，$\hat{X}_k$就等于测量出来的结果$X_k$_。

## 卡尔曼滤波协方差矩阵详细推导

上面我们已经求得了卡尔曼增益的表达式：

$$K_{k}=\frac{P_{k}^-H^{T}}{HP_{k}^-H^{T}+R}$$

其中只有先验误差协方差矩阵$P^-_k$未知，下面求解$P^-_k$:

- $P^-_k = E[e^-{e^-_k}^T]$ 其中$e^-_k = X_k - \hat{X}^-_k$ ;

可以得到：

$$
P^-_k = AP_{k-1}A^T + Q
$$

通过卡尔曼滤波器估计状态变量的值：

1. **预测**
   - 先验估计：$\hat{X_k^-} = A\hat{X}_{k-1}+BU_{k-1}$
   - 先验误差协方差矩阵：$P^-_k = AP_{k-1}A^T + Q$
2. **校正**
   - 卡尔曼增益：$K_{k}=\frac{P_{k}^-H^{T}}{HP_{k}^-H^{T}+R}$
   - 后验估计：$\hat{X}_{k}=\hat{X}_{k}^{-}+K_{k}(Z_{k}-H\hat{X}_{k}^{-})$
   - **更新误差协方差矩阵**用于下一次求解先验误差协方差矩阵,$P_k = (I - K_kH)P^-_k$

> 卡尔曼增益的分母也可以理解成是测量误差的协方差矩阵$S_k = HP_{k}^-H^{T}+R$

**这里得到的$\hat{X}_k$就是经过卡尔曼滤波得到的最优估计。**
之所以是最优估计，因为这里的卡尔曼增益是一个使得估计值与真实值误差最小的增益。

_以上就是卡尔曼滤波算法的五个重要公式。_

可以看到先验误差协方差矩阵这里每一次的预测都要用到上一次的结果，一直往前推，直到初始的时候，需要**赋予一个初值**：$X_0$和$P_0$.
$P_0$表示对系统初始状态估计的置信度。

## 卡尔曼滤波的直观理解

- **卡尔曼增益$K_k$**：负责融合估计值和测量值，测量方差大时就相信测量值，测量方差小就相信估计值。
- **状态估计误差协方差矩阵**$P_k$：初始状态与过程噪声有关，并且随着迭代次数$k$增加，$P_k$也在变换，因为使用了上一次的结果，且上一次的结果来自卡尔曼增益对观测与估计的融合，所以$P_k$也会不断减小。
- **测量误差协方差矩阵$R$**：来自传感器误差。
- **过程噪声协方差矩阵$Q$**：来自世界的不确定性，或者模型的不确定性。

_根据不太准确的估计值和不太准确的测量值去得到一个最优估计_

## 扩展卡尔曼滤波器EKF

> 卡尔曼滤波在非线性系统中的应用，扩展卡尔曼滤波器就是非线性系统转换成线性系统求解。

_正态分布的随机变量通过非线性系统后就不再是正态的了。_

非线性系统方程：

$$
\begin{cases}
X_k = f(X_{k-1}, U_{k-1}, w_{k-1}) \\
Z_k = h(X_k, v_k)
\end{cases}
$$

其中，$P(w)\sim N(0,Q)$,$P(v)\sim N(0,R)$

通过**泰勒级数**将非线性系统线性化，但是因为系统有误差，无法在真实点线性化。
所以我们在$k-1$时刻的后验估计即上一次的后验估计进行线性化。

$$
X_k = f(\hat{X}_{k-1}, U_{k-1}, w_{k-1}) + A(X_k - \hat{X}_{k-1}) + W_kw_{k-1}
$$

$A$是雅可比矩阵，$W_k$是$w_k$对$f$的偏导。_A随着k在一直变换_。

对$Z_k$线性化：

$$
Z_{k}=h(\tilde{X}_{k},\nu_{k})+H(X_{k}-\tilde{X}_{k})+V v_{k}
$$

$H$是$x$对$h$的偏导，$V$是$h$对$v$的偏导。

先假设误差$w_k$和$v_k$都为0，则：$\tilde{X}_k = f(\hat{X}_{k-1}, U_{k-1}, 0)$, $\tilde{Z}_k = h(\tilde{X}_{k},0)$

$$
\begin{cases}X_k = \tilde{X}_k  + A(X_k - \hat{X}_{k-1}) + W_kw_{k-1} \\
Z_{k}=\tilde{Z}_k+H(X_{k}-\tilde{X}_{k})+V v_{k}
\end{cases}
$$

$$\begin{aligned}&P(w)\sim N(0,Q)\\&P(Ww)\sim N(0,WQW^T)\end{aligned}$$

同理：

$$
P(Vv)\sim N(0,VRV^T)
$$

非线性的卡尔曼滤波公式如下，只有$Q,R$还有$H\hat{X}_k^-$需要修改：

_// 未完待续_
